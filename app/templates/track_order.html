{% extends 'base.html' %}

{% block title %}Track Order {{ order.order_number }} - Crispy Clucker's{% endblock %}

{% block content %}
<!-- Header -->
<header class="header">
    <div class="header-inner">
        <a href="{{ url_for('main.home') }}" class="logo">
            <div class="logo-icon">üçó</div>
            <span>Crispy Clucker's</span>
        </a>
        <nav class="nav">
            <a href="{{ url_for('main.home') }}">Home</a>
            <a href="{{ url_for('main.menu') }}">Menu</a>
        </nav>
    </div>
</header>

<div class="tracking-page">
    <div class="tracking-container">
        <div class="tracking-header">
            <h1>Order Tracking</h1>
            <div class="order-number-display">
                <span class="label">Order Number</span>
                <span class="number" id="orderNumber">{{ order.order_number }}</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="tracking-progress">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: {{ order.get_progress_percentage() }}%"></div>
            </div>
            <div class="progress-steps">
                <div class="step {{ 'active' if order.status in ['paid', 'preparing', 'ready', 'completed'] else '' }}" data-status="paid">
                    <div class="step-icon">üìù</div>
                    <span>Order Received</span>
                </div>
                <div class="step {{ 'active' if order.status in ['preparing', 'ready', 'completed'] else '' }}" data-status="preparing">
                    <div class="step-icon">üë®‚Äçüç≥</div>
                    <span>Preparing</span>
                </div>
                <div class="step {{ 'active' if order.status in ['ready', 'completed'] else '' }}" data-status="ready">
                    <div class="step-icon">‚úÖ</div>
                    <span>Ready</span>
                </div>
                <div class="step {{ 'active' if order.status == 'completed' else '' }}" data-status="completed">
                    <div class="step-icon">üéâ</div>
                    <span>Picked Up</span>
                </div>
            </div>
        </div>

        <!-- Status Card -->
        <div class="status-card" id="statusCard">
            <div class="status-icon" id="statusIcon">
                {% if order.status == 'paid' %}üé´
                {% elif order.status == 'preparing' %}üç≥
                {% elif order.status == 'ready' %}üîî
                {% elif order.status == 'completed' %}‚ú®
                {% else %}‚è≥{% endif %}
            </div>
            <div class="status-info">
                <h2 id="statusTitle">
                    {% if order.status == 'paid' %}Order Received!
                    {% elif order.status == 'preparing' %}We're Cooking!
                    {% elif order.status == 'ready' %}Ready for Pickup!
                    {% elif order.status == 'completed' %}Order Complete
                    {% else %}Processing{% endif %}
                </h2>
                <p id="statusMessage">
                    {% if order.status == 'paid' %}We've received your order and will start preparing it soon.
                    {% elif order.status == 'preparing' %}Your delicious meal is being prepared with care.
                    {% elif order.status == 'ready' %}Your order is ready! Come pick it up at the counter.
                    {% elif order.status == 'completed' %}Thanks for dining with us! See you next time.
                    {% else %}Your order is being processed.{% endif %}
                </p>
            </div>
        </div>

        <!-- Timer Display -->
        <div class="timer-display">
            <div class="timer-item">
                <span class="timer-label">Elapsed Time</span>
                <span class="timer-value" id="elapsedTime">--:--</span>
            </div>
            <div class="timer-item">
                <span class="timer-label">Estimated Ready</span>
                <span class="timer-value" id="estimatedTime">~{{ order.estimated_ready_minutes }} min</span>
            </div>
        </div>

        <!-- Order Details -->
        <div class="order-details-card">
            <h3>Order Details</h3>
            <div class="order-items-list">
                {% for item in order.items %}
                <div class="order-item-row">
                    <span class="item-qty">{{ item.quantity }}x</span>
                    <span class="item-name">{{ item.name }}</span>
                    <span class="item-price">${{ "%.2f"|format(item.price * item.quantity) }}</span>
                </div>
                {% endfor %}
            </div>
            <div class="order-total-row">
                <span>Total</span>
                <span>${{ "%.2f"|format(order.total) }}</span>
            </div>
        </div>

        <!-- Event Timeline -->
        <div class="timeline-card">
            <h3>Order Timeline</h3>
            <div class="timeline" id="timeline">
                {% for event in order.tracking_events %}
                <div class="timeline-event">
                    <div class="timeline-dot"></div>
                    <div class="timeline-content">
                        <span class="event-status">{{ event.status|title }}</span>
                        <span class="event-time">{{ event.created_at.strftime('%I:%M %p') }}</span>
                        {% if event.notes %}
                        <span class="event-notes">{{ event.notes }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="tracking-actions">
            <a href="{{ url_for('main.menu') }}" class="btn btn-red">Order More Food</a>
            <a href="{{ url_for('main.home') }}" class="btn btn-outline-red">Back to Home</a>
        </div>
    </div>
</div>

<style>
.tracking-page {
    min-height: 100vh;
    background: linear-gradient(135deg, #fff5f5 0%, #fff 50%, #fef2f2 100%);
    padding: 6rem 1rem 2rem;
}

.tracking-container {
    max-width: 600px;
    margin: 0 auto;
}

.tracking-header {
    text-align: center;
    margin-bottom: 2rem;
}

.tracking-header h1 {
    font-size: 2rem;
    color: var(--dark);
    margin-bottom: 1rem;
}

.order-number-display {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.order-number-display .label {
    font-size: 0.875rem;
    color: var(--gray);
}

.order-number-display .number {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--red);
    font-family: monospace;
    letter-spacing: 2px;
}

.tracking-progress {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.progress-bar {
    height: 8px;
    background: var(--light-gray);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--red), #ff6b6b);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    opacity: 0.4;
    transition: all 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step-icon {
    font-size: 1.5rem;
}

.step span {
    font-size: 0.75rem;
    color: var(--gray);
    text-align: center;
}

.status-card {
    background: white;
    border-radius: 1rem;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 1.5rem;
}

.status-icon {
    font-size: 3rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.status-info h2 {
    font-size: 1.5rem;
    color: var(--dark);
    margin-bottom: 0.5rem;
}

.status-info p {
    color: var(--gray);
}

.timer-display {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.timer-item {
    background: white;
    border-radius: 1rem;
    padding: 1.25rem;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.timer-label {
    display: block;
    font-size: 0.75rem;
    color: var(--gray);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.timer-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--dark);
    font-family: monospace;
}

.order-details-card,
.timeline-card {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.order-details-card h3,
.timeline-card h3 {
    font-size: 1rem;
    color: var(--dark);
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--light-gray);
}

.order-item-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem 0;
}

.item-qty {
    font-weight: 600;
    color: var(--red);
    min-width: 30px;
}

.item-name {
    flex: 1;
    color: var(--dark);
}

.item-price {
    font-weight: 600;
    color: var(--dark);
}

.order-total-row {
    display: flex;
    justify-content: space-between;
    padding-top: 1rem;
    margin-top: 0.5rem;
    border-top: 2px solid var(--light-gray);
    font-weight: 700;
    font-size: 1.125rem;
}

.timeline {
    position: relative;
}

.timeline-event {
    display: flex;
    gap: 1rem;
    padding-bottom: 1rem;
    position: relative;
}

.timeline-event:last-child {
    padding-bottom: 0;
}

.timeline-event:not(:last-child)::before {
    content: '';
    position: absolute;
    left: 6px;
    top: 20px;
    bottom: 0;
    width: 2px;
    background: var(--light-gray);
}

.timeline-dot {
    width: 14px;
    height: 14px;
    background: var(--red);
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 4px;
}

.timeline-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.event-status {
    font-weight: 600;
    color: var(--dark);
}

.event-time {
    font-size: 0.75rem;
    color: var(--gray);
}

.event-notes {
    font-size: 0.875rem;
    color: var(--gray);
    font-style: italic;
}

.tracking-actions {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.tracking-actions .btn {
    flex: 1;
    max-width: 200px;
}

/* Real-time update indicator */
.live-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #10B981;
    margin-left: 0.5rem;
}

.live-dot {
    width: 8px;
    height: 8px;
    background: #10B981;
    border-radius: 50%;
    animation: blink 1s infinite;
}

@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
}
</style>

<script>
const orderId = {{ order.id }};
const orderCreatedAt = new Date('{{ order.created_at.isoformat() }}');
let currentStatus = '{{ order.status }}';

// Update elapsed time every second
function updateElapsedTime() {
    const now = new Date();
    const elapsed = Math.floor((now - orderCreatedAt) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('elapsedTime').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

// Fetch latest order status
async function fetchOrderStatus() {
    try {
        const response = await fetch(`/api/track/${orderId}`);
        const data = await response.json();
        
        if (data.status !== currentStatus) {
            currentStatus = data.status;
            updateUI(data);
        }
        
        // Update progress bar
        document.getElementById('progressFill').style.width = data.progress + '%';
        
    } catch (error) {
        console.error('Error fetching order status:', error);
    }
}

function updateUI(data) {
    // Update status icon and messages
    const statusIcons = {
        'paid': 'üé´',
        'preparing': 'üç≥',
        'ready': 'üîî',
        'completed': '‚ú®'
    };
    
    const statusTitles = {
        'paid': 'Order Received!',
        'preparing': "We're Cooking!",
        'ready': 'Ready for Pickup!',
        'completed': 'Order Complete'
    };
    
    const statusMessages = {
        'paid': "We've received your order and will start preparing it soon.",
        'preparing': 'Your delicious meal is being prepared with care.',
        'ready': 'Your order is ready! Come pick it up at the counter.',
        'completed': 'Thanks for dining with us! See you next time.'
    };
    
    document.getElementById('statusIcon').textContent = statusIcons[data.status] || '‚è≥';
    document.getElementById('statusTitle').textContent = statusTitles[data.status] || 'Processing';
    document.getElementById('statusMessage').textContent = statusMessages[data.status] || 'Your order is being processed.';
    
    // Update progress steps
    const steps = document.querySelectorAll('.step');
    const statusOrder = ['paid', 'preparing', 'ready', 'completed'];
    const currentIndex = statusOrder.indexOf(data.status);
    
    steps.forEach((step, index) => {
        if (index <= currentIndex) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
    
    // Update timeline
    if (data.events && data.events.length > 0) {
        const timeline = document.getElementById('timeline');
        timeline.innerHTML = data.events.map(event => `
            <div class="timeline-event">
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <span class="event-status">${event.status.charAt(0).toUpperCase() + event.status.slice(1)}</span>
                    <span class="event-time">${new Date(event.created_at).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})}</span>
                    ${event.notes ? `<span class="event-notes">${event.notes}</span>` : ''}
                </div>
            </div>
        `).join('');
    }
    
    // Play notification sound on status change (optional)
    if (data.status === 'ready') {
        // You could add a notification sound here
        document.title = 'üîî Order Ready! - Crispy Clucker\'s';
    }
}

// Start updates
updateElapsedTime();
setInterval(updateElapsedTime, 1000);

// Poll for status updates every 5 seconds
fetchOrderStatus();
setInterval(fetchOrderStatus, 5000);
</script>
{% endblock %}


